<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>公車動態管理系統 - 精簡版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        #map { height: 500px; width: 100%; border-radius: 1.5rem; z-index: 1; }
        .error-toast { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        /* 去回程按鈕活性樣式 */
        .btn-dir-active { @apply bg-blue-600 text-white shadow-md; }
        .btn-dir-inactive { @apply bg-slate-100 text-slate-400 hover:bg-slate-200; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans min-h-screen pb-20">

    <!-- 訊息提示通知 -->
    <div id="toast" class="hidden fixed bottom-6 left-1/2 -translate-x-1/2 z-[2000] flex items-center gap-3 px-6 py-4 rounded-2xl shadow-2xl text-white font-bold error-toast">
        <i id="toast-icon" data-lucide="info"></i>
        <span id="toast-msg">操作成功</span>
    </div>

    <nav class="bg-white border-b sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 p-2 rounded-xl text-white shadow-lg shadow-blue-200">
                    <i data-lucide="bus"></i>
                </div>
                <span class="text-xl font-black italic">BUS<span class="text-blue-600">PRO</span></span>
            </div>
            <div id="auth-area" class="flex items-center gap-4">
                <div class="animate-pulse bg-slate-100 h-10 w-32 rounded-full"></div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto p-6 grid grid-cols-1 lg:grid-cols-12 gap-6">
        <!-- 左側控制面板 -->
        <div class="lg:col-span-4 space-y-6">
            <div class="bg-white rounded-3xl border shadow-sm overflow-hidden">
                <div class="p-5 border-b flex justify-between items-center bg-slate-50/50">
                    <h2 class="font-bold flex items-center gap-2"><i data-lucide="settings" class="w-4 h-4"></i> 路線管理</h2>
                </div>

                <!-- 僅保留手動新增與 Excel 匯入 -->
                <div id="admin-panel" class="p-4 border-b bg-blue-50/20 hidden space-y-3">
                    <div class="flex gap-2">
                        <input id="new-route-name" type="text" placeholder="輸入路線名稱 (例: 101)" class="flex-1 px-4 py-2 rounded-xl border focus:ring-2 focus:ring-blue-500 outline-none text-sm">
                        <button id="btn-add-route" class="bg-blue-600 text-white p-2 rounded-xl hover:bg-blue-700 transition">
                            <i data-lucide="plus"></i>
                        </button>
                    </div>
                    <div class="w-full">
                        <button onclick="document.getElementById('file-input').click()" class="w-full bg-emerald-600 text-white py-2.5 rounded-xl text-xs font-black uppercase flex items-center justify-center gap-2 hover:bg-emerald-700 transition">
                            <i data-lucide="file-spreadsheet" class="w-4 h-4"></i> 批次匯入站點 (EXCEL/CSV)
                        </button>
                        <input type="file" id="file-input" class="hidden" accept=".xlsx,.xls,.csv">
                    </div>
                </div>

                <div id="route-list" class="p-2 max-h-[300px] overflow-y-auto custom-scrollbar space-y-1">
                    <div class="p-8 text-center text-slate-400 italic text-sm">正在載入數據...</div>
                </div>
            </div>

            <!-- 站點清單：去回程切換在此處 -->
            <div class="bg-white rounded-3xl border shadow-sm overflow-hidden">
                <div class="p-5 border-b bg-slate-50/50 flex flex-col gap-3">
                    <div class="flex justify-between items-center">
                        <h2 class="font-bold flex items-center gap-2"><i data-lucide="list" class="w-4 h-4"></i> 站點清單</h2>
                        <span id="station-count" class="text-[10px] bg-slate-200 px-2 py-0.5 rounded-full font-black">0</span>
                    </div>
                    <!-- 按鈕組：切換去程與回程 -->
                    <div class="flex gap-2 p-1 bg-slate-100 rounded-xl">
                        <button onclick="window.switchDir(0)" id="btn-dir-0" class="flex-1 py-1.5 rounded-lg text-xs font-bold transition-all bg-blue-600 text-white shadow-sm">去程</button>
                        <button onclick="window.switchDir(1)" id="btn-dir-1" class="flex-1 py-1.5 rounded-lg text-xs font-bold transition-all text-slate-400">回程</button>
                    </div>
                </div>
                <div id="station-list" class="p-2 max-h-[400px] overflow-y-auto custom-scrollbar space-y-2">
                    <div class="p-8 text-center text-slate-400 italic text-sm">請先從上方選取公車路線</div>
                </div>
            </div>
        </div>

        <!-- 右側地圖與資訊 -->
        <div class="lg:col-span-8 space-y-6">
            <div id="map" class="shadow-xl border border-white"></div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-white p-6 rounded-3xl border shadow-sm">
                    <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 italic">Operator Details</h4>
                    <div id="op-info" class="space-y-2">
                        <p class="text-slate-400 italic text-sm">選取路線以查看經營單位</p>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-3xl border shadow-sm">
                    <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 italic">System Monitor</h4>
                    <div id="log-box" class="text-[11px] font-mono text-slate-500 h-16 overflow-y-auto custom-scrollbar space-y-1">
                        <div>> 系統初始化完成</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, addDoc, deleteDoc, updateDoc, setDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDM-w_NjBnv5wZnlwPGsVjJFlEDBBDdaSQ",
            authDomain: "bus-run-time.firebaseapp.com",
            projectId: "bus-run-time",
            storageBucket: "bus-run-time.firebasestorage.app",
            messagingSenderId: "169319406878",
            appId: "1:169319406878:web:e9e2b2172b80f0c46ffd0f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        const appId = 'bus-tracker-v4';

        let user = null, currentDir = 0, currentRid = null, map, markers = [], routeLine = null;

        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            const msgEl = document.getElementById('toast-msg');
            msgEl.innerText = msg;
            toast.className = `fixed bottom-6 left-1/2 -translate-x-1/2 z-[2000] flex items-center gap-3 px-6 py-4 rounded-2xl shadow-2xl text-white font-bold error-toast ${type === 'success' ? 'bg-emerald-600' : 'bg-red-600'}`;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
            log(msg);
        }

        function log(msg) {
            const box = document.getElementById('log-box');
            const div = document.createElement('div');
            div.innerText = `> ${new Date().toLocaleTimeString()} ${msg}`;
            box.prepend(div);
        }

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([24.993, 121.301], 13);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
            L.control.zoom({ position: 'bottomright' }).addTo(map);
        }

        onAuthStateChanged(auth, (u) => {
            user = u;
            const area = document.getElementById('auth-area');
            const admin = document.getElementById('admin-panel');
            if (u) {
                area.innerHTML = `
                    <div class="flex items-center gap-3 bg-white p-1 rounded-full border shadow-sm pr-4">
                        <img src="${u.photoURL}" class="w-8 h-8 rounded-full border">
                        <button id="btn-logout" class="text-xs font-black text-red-500">登出</button>
                    </div>`;
                document.getElementById('btn-logout').onclick = () => signOut(auth);
                admin.classList.remove('hidden');
            } else {
                area.innerHTML = `<button id="btn-login" class="bg-blue-600 text-white px-6 py-2 rounded-xl text-sm font-bold shadow-lg hover:bg-blue-700 transition">管理員登入</button>`;
                document.getElementById('btn-login').onclick = () => signInWithPopup(auth, provider).catch(e => showToast(e.message, 'error'));
                admin.classList.add('hidden');
            }
            loadRoutes();
            lucide.createIcons();
        });

        function loadRoutes() {
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'routes'));
            onSnapshot(q, (snap) => {
                const list = document.getElementById('route-list');
                list.innerHTML = '';
                snap.forEach(d => {
                    const data = d.data();
                    const active = currentRid === d.id;
                    const div = document.createElement('div');
                    div.className = `p-4 rounded-2xl cursor-pointer flex justify-between items-center transition ${active ? 'bg-blue-600 text-white shadow-lg' : 'hover:bg-slate-100 text-slate-600'}`;
                    div.innerHTML = `
                        <div class="flex-1" onclick="window.selectRoute('${d.id}')">
                            <p class="font-black text-sm">${data.name}</p>
                            <p class="text-[10px] opacity-70">${data.op || '自定義業者'}</p>
                        </div>
                        ${user ? `<button onclick="window.delRoute('${d.id}')" class="p-2 hover:text-red-400 transition"><i data-lucide="trash-2" class="w-4 h-4"></i></button>` : ''}
                    `;
                    list.appendChild(div);
                });
                lucide.createIcons();
            });
        }

        window.selectRoute = (id) => {
            currentRid = id;
            loadRoutes();
            loadStations();
            updateOpInfo(id);
        };

        async function updateOpInfo(id) {
            const snap = await getDocs(query(collection(db, 'artifacts', appId, 'public', 'data', 'routes')));
            const data = snap.docs.find(d => d.id === id)?.data();
            const box = document.getElementById('op-info');
            if (data) {
                box.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-blue-50 rounded-xl flex items-center justify-center text-blue-600"><i data-lucide="building-2"></i></div>
                        <div>
                            <p class="font-bold text-slate-700">${data.op || '手動建立路線'}</p>
                            <p class="text-xs text-slate-400">${data.phone || '尚未提供聯繫資訊'}</p>
                        </div>
                    </div>
                `;
            }
            lucide.createIcons();
        }

        function loadStations() {
            if (!currentRid) return;
            const q = query(
                collection(db, 'artifacts', appId, 'public', 'data', 'routes', currentRid, 'stations'),
                where('dir', '==', currentDir)
            );
            onSnapshot(q, (snap) => {
                const list = document.getElementById('station-list');
                list.innerHTML = '';
                const sorted = [];
                snap.forEach(d => sorted.push({ id: d.id, ...d.data() }));
                sorted.sort((a,b) => a.order - b.order);
                document.getElementById('station-count').innerText = sorted.length;
                
                if (sorted.length === 0) {
                    list.innerHTML = `<div class="p-8 text-center text-slate-300 text-xs italic">此方向暫無站點，請匯入 Excel 數據</div>`;
                }

                sorted.forEach(s => {
                    const div = document.createElement('div');
                    div.className = "p-3 bg-white border rounded-xl flex justify-between items-center shadow-sm hover:border-blue-200 transition";
                    div.innerHTML = `
                        <div class="flex items-center gap-3">
                            <span class="w-6 h-6 bg-slate-100 rounded-lg flex items-center justify-center text-[10px] font-black">${s.order}</span>
                            <span class="font-bold text-sm text-slate-700">${s.name}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            ${user ? `<button onclick="window.delStation('${s.id}')" class="text-slate-300 hover:text-red-500 transition"><i data-lucide="trash" class="w-3 h-3"></i></button>` : ''}
                        </div>
                    `;
                    list.appendChild(div);
                });
                updateMap(sorted);
                lucide.createIcons();
            });
        }

        document.getElementById('btn-add-route').onclick = async () => {
            const input = document.getElementById('new-route-name');
            const name = input.value.trim();
            if (!name || !user) return;
            
            try {
                log(`建立新路線: ${name}`);
                const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'routes');
                await addDoc(colRef, {
                    name,
                    op: "手動管理業者",
                    createdAt: Date.now(),
                    creator: user.uid
                });
                input.value = '';
                showToast("路線新增成功");
            } catch (e) {
                showToast(`儲存錯誤: ${e.message}`, 'error');
            }
        };

        document.getElementById('file-input').onchange = (e) => {
            const file = e.target.files[0];
            if (!file || !currentRid) return showToast("請先選取左側路線", "error");
            
            const reader = new FileReader();
            reader.onload = async (evt) => {
                try {
                    const bstr = evt.target.result;
                    const wb = XLSX.read(bstr, { type: 'binary' });
                    const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                    
                    log(`正在批次處理 ${data.length} 個站點...`);
                    for (const row of data) {
                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'routes', currentRid, 'stations'), {
                            name: row.Name || row.站名 || "未命名站點",
                            lat: parseFloat(row.Lat || row.緯度),
                            lng: parseFloat(row.Lng || row.經度),
                            order: parseInt(row.Order || row.順序 || 0),
                            dir: parseInt(row.Dir || row.方向 || currentDir)
                        });
                    }
                    showToast(`完成匯入 ${data.length} 筆資料`);
                    e.target.value = ''; // 清除 input 以便下次匯入
                } catch (err) {
                    showToast("讀取失敗，請檢查檔案格式", "error");
                }
            };
            reader.readAsBinaryString(file);
        };

        window.delRoute = (id) => confirm("確定刪除此路線及其所有站點？") && deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'routes', id));
        window.delStation = (sid) => deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'routes', currentRid, 'stations', sid));

        window.switchDir = (d) => {
            currentDir = d;
            const btn0 = document.getElementById('btn-dir-0');
            const btn1 = document.getElementById('btn-dir-1');
            
            if (d === 0) {
                btn0.className = 'flex-1 py-1.5 rounded-lg text-xs font-bold transition-all bg-blue-600 text-white shadow-sm';
                btn1.className = 'flex-1 py-1.5 rounded-lg text-xs font-bold transition-all text-slate-400';
            } else {
                btn0.className = 'flex-1 py-1.5 rounded-lg text-xs font-bold transition-all text-slate-400';
                btn1.className = 'flex-1 py-1.5 rounded-lg text-xs font-bold transition-all bg-blue-600 text-white shadow-sm';
            }
            
            loadStations();
        };

        function updateMap(stations) {
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            if (routeLine) map.removeLayer(routeLine);
            
            const points = [];
            stations.forEach(s => {
                if (s.lat && s.lng) {
                    points.push([s.lat, s.lng]);
                    const m = L.circleMarker([s.lat, s.lng], { 
                        radius: 6, 
                        color: '#3b82f6', 
                        weight: 2,
                        fillOpacity: 1, 
                        fillColor: '#fff' 
                    }).addTo(map).bindPopup(`<b>${s.name}</b><br>順序: ${s.order}`);
                    markers.push(m);
                }
            });
            
            if (points.length > 1) {
                routeLine = L.polyline(points, { color: '#3b82f6', weight: 4, opacity: 0.6, dashArray: '8, 12' }).addTo(map);
                map.fitBounds(L.featureGroup(markers).getBounds(), { padding: [50, 50] });
            } else if (points.length === 1) {
                map.setView(points[0], 15);
            }
        }

        window.onload = () => { initMap(); lucide.createIcons(); };
    </script>
</body>
</html>